from snakemake.utils import min_version
from snakemake.utils import validate

# do not allow subdirectories as part of `sample` or `i` wildcards
wildcard_constraints:
    sample="[^/]+",

# Define minimum Snakemake version
min_version("6.12.1")

# Include Config file
configfile: "config/config.yaml"

# Include rules
include: "rules/misc_snake.smk"
include: "rules/preprocessing.smk"
include: "rules/revseq_basic.smk"
include: "rules/dehuman.smk"
include: "rules/qc.smk"

# include local rules
localrules:
    all,

# final rule of pipeline
# defines output
rule all:
    input:
        #preprocessing. Optional if running also revseq_basic.smk
        expand(config["inputOutput"]["output_dir"]+"/{sample}/trim_galore/{sample}_merged_R1_val_1.fq.gz", sample = sample_ids),
        #expand(config["inputOutput"]["output_dir"]+"/{sample}/merge_lanes/{sample}_merged_R1.fastq.gz", sample = sample_ids, lane = lane_ids),
        #expand(config["inputOutput"]["output_dir"]+"/{sample}/merge_lanes/{sample}_merged_R2.fastq.gz", sample = sample_ids, lane = lane_ids),
        config["resources"]["reference"] + '.bwt',
        #pipeline
        #expand(config["inputOutput"]["output_dir"]+"/{sample}/bwa/mapped_reads.bam", sample = sample_ids),
        #expand(config["inputOutput"]["output_dir"]+"/{sample}/sort/sorted_reads.bam", sample = sample_ids),
        expand(config["inputOutput"]["output_dir"]+"/{sample}/pileup/{sample}_pileup.txt", sample = sample_ids),
        expand(config["inputOutput"]["output_dir"]+"/{sample}/validate_assignment/{sample}_validation.txt", sample = sample_ids),
        #dehuman
        expand(config["inputOutput"]["output_dir"]+"/{sample}/dehuman/{sample}_dehuman.cram", sample = sample_ids),
        #qc
        expand(config["inputOutput"]["output_dir"]+"/{sample}/fastqc_dehuman/{sample}_dehuman_1.fastqc.zip", sample = sample_ids),
        #expand(config["inputOutput"]["output_dir"]+"/{sample}/samtoolsstats/{sample}_samtools_stats.txt", sample=sample_ids),
        #expand(config["inputOutput"]["output_dir"]+"/{sample}/rseqc/{sample}_bam_stat.txt", sample=sample_ids),
        #expand(config["inputOutput"]["output_dir"]+"/{sample}/idxstats/{sample}_idxstats.txt", sample=sample_ids),
        #expand(config["inputOutput"]["output_dir"]+"/{sample}/assign_virus/{sample}_count_table.tsv", sample=sample_ids),
        config["inputOutput"]["output_dir"]+"/multiqc/multiqc_report.html",
    output:
        config["inputOutput"]["output_dir"]+"/complete.txt",
    shell:
        "date > {output}"




