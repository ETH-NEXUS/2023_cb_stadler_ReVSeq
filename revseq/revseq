#!/bin/bash

scriptdir="$(dirname $(which $0))"
. ${scriptdir}/revseq.conf

case "$1" in
        syncviollier)
                echo "Sync Viollier"
		cd ${mirror}
                # HACK delete previous partial downloads
                . <(grep '^mirror=' revseq.conf)
                echo "Removing partial files from:" "${mirror}/"
                find "${mirror}/" -type f -name '*.filepart' -print0 | xargs -r -0 rm -vi
		# Mirroring samples
                lftp -c "set cmd:move-background false; set net:timeout $(( contimeout / retries)); set net:max-retries ${retries}; set net:reconnect-interval-base 8; set xfer:timeout ${iotimeout}; connect sftp://${fileserver}${srvport:+:${srvport}}; mirror --continue --no-perms --parallel=${parallel} --loop --target-directory=${mirror}/ ${source}"
		# Mirroring metadata
		lftp -c "set cmd:move-background false; set net:timeout $(( contimeout / retries)); set net:max-retries ${retries}; set net:reconnect-interval-base 8; set xfer:timeout ${iotimeout}; connect sftp://${fileserver}${srvport:+:${srvport}}; mirror --continue --no-perms --parallel=${parallel} --loop --target-directory=${mirror}/ ${metadata}"
	;;
	link_samples)
		echo "Restructuring the synced samples using softlinks"
		python ${scriptdir}/link_restructure.py --mirror ${mirror} --sampledir {$sampledir}
	;;
        #uploadviollier)
        #        echo "Uploading Viollier"
        #;;
        anonymize_samples)
                python ${scriptdir}/anonymize_sample_names.py --anontable ${anontable} --sampledir ${sampledir} --samplemapfile ${samplemapfile} --anonymizeddir ${anonymizeddir} --emptyfile ${emptyfile}
        ;;
        dryrun)
		cd ${pipelinedir}
		snakemake --use-conda -c3 --configfile /data/config/config.yaml -n
        ;;
        runpipeline)
		cd ${pipelinedir}
                snakemake --use-conda -c3 --configfile /data/config/config.yaml
        ;;
        #packagedata)
        #
        #;;
        *)
                echo "Unkown sub-command ${1}" > /dev/stderr
                exit 2
        ;;
esac
